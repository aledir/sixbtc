# ==============================================================================
# SIXBTC MASTER CONFIGURATION
# ==============================================================================
# Last updated: 2025-12-20
# Version: 1.0.0
#
# IMPORTANT: All values in this file are REQUIRED - no fallback defaults!
# Missing or invalid config will cause system to crash at startup (Fast Fail)
# Sensitive credentials (API keys, passwords) go in .env, NOT here

system:
  name: "SixBTC"
  version: "1.0.0"
  execution_mode: hybrid  # sync, async, multiprocess, hybrid

# ==============================================================================
# GLOBAL TIMEFRAMES (used by downloader, generator, backtester, executor)
# ==============================================================================
timeframes: ['15m', '30m', '1h', '4h', '1d']

# ==============================================================================
# DIRECTORIES
# ==============================================================================
directories:
  data: data

# ==============================================================================
# DATABASE (PostgreSQL via Docker)
# ==============================================================================
database:
  # Connection settings (from .env)
  host: ${DB_HOST}
  port: ${DB_PORT}
  database: ${DB_NAME}
  user: ${DB_USER}
  password: ${DB_PASSWORD}

  pool:
    min_connections: 5
    max_connections: 50
    pool_recycle: 3600

# ==============================================================================
# HYPERLIQUID EXCHANGE
# ==============================================================================
hyperliquid:
  private_key: ${HL_PRIVATE_KEY}
  vault_address: ${HL_VAULT_ADDRESS}

  # User address for WebSocket private channels (webData2, userFills)
  # Required for trade sync and live performance tracking
  # Optional - if not set, trade sync will be disabled
  user_address: "${HL_USER_ADDRESS:-}"

  # Fees for backtesting (taker fee = market orders)
  fee_rate: 0.00045  # 0.045% taker fee
  slippage: 0.0005   # 0.05% estimated slippage

  websocket:
    ping_interval: 30
    ping_timeout: 10

  # Trade sync configuration
  # Synchronizes closed trades from Hyperliquid to database
  trade_sync:
    enabled: true
    fills_lookback_days: 7  # How far back to look for fills

  subaccounts:
    total: 10
    test_mode:
      enabled: false
      count: 3
      capital_per_account: 100

# ==============================================================================
# RISK MANAGEMENT
# ==============================================================================
risk:
  sizing_mode: atr  # 'fixed' or 'atr'

  fixed_fractional:
    risk_per_trade_pct: 0.02
    max_position_size_pct: 0.20

  atr:
    period: 14
    stop_multiplier: 2.0
    take_profit_multiplier: 3.0
    min_risk_reward: 1.5
    volatility_scaling:
      enabled: true
      low_volatility_threshold: 0.015
      high_volatility_threshold: 0.05
      scaling_factor: 0.5

  limits:
    max_open_positions_per_subaccount: 10  # Increased from 6

  emergency:
    max_portfolio_drawdown: 0.30
    max_daily_loss: 0.10
    max_subaccount_drawdown: 0.25
    max_consecutive_losses: 5

  # Trailing stop configuration
  trailing:
    enabled: true                    # Enable trailing stop service
    min_adjustment_pct: 0.005        # Min 0.5% improvement to update SL
    update_cooldown_sec: 10          # Min seconds between SL updates
    breakeven_buffer_pct: 0.002      # 0.2% buffer above breakeven

# ==============================================================================
# AI CONFIGURATION
# ==============================================================================
ai:
  mode: cli  # "cli" or "api"
  cli:
    model: claude
    timeout: 300
  api:
    model: claude-sonnet-4-20250514
    timeout: 120

# ==============================================================================
# GENERATION (AI Templates + Parametric Variations)
# ==============================================================================
generation:
  min_interval_seconds: 0      # Min seconds between AI calls
  parallel_threads: 1
  # NOTE: Each template generates ALL parametric variations (no AI cost)
  # Flow control is handled by pipeline backpressure below
  # Leverage is read from DB (coins.max_leverage), not configured here

  # Parametric optimization (runs after base strategy generation)
  parametric:
    enabled: true              # Enable parametric optimization
    top_k: 3                   # Save top K parameter combinations per pattern
    parameter_space:
      sl_pct: [0.01, 0.015, 0.02, 0.025, 0.03]
      tp_pct: [0.02, 0.03, 0.05, 0.07, 0.10]
      leverage: [1, 2, 3, 5]
      exit_bars: [0, 10, 20, 50]

# ==============================================================================
# PIPELINE FLOW CONTROL (Multi-Level Backpressure System)
# ==============================================================================
# Prevents queue overflow by limiting strategies at each stage.
# Each module checks its downstream queue before processing.
# System self-regulates: slow backtester -> queues fill -> upstream pauses
pipeline:
  queue_limits:
    generated: 100      # Max GENERATED strategies waiting for validation
    validated: 50       # Max VALIDATED strategies waiting for backtest
    tested: 100         # Max TESTED strategies waiting for classification (increased from 30)

  backpressure:
    check_interval: 10        # Seconds between backpressure checks
    base_cooldown: 30         # Base cooldown when backpressure triggers
    max_cooldown: 120         # Maximum cooldown (2 minutes)
    cooldown_increment: 2     # Extra seconds per strategy over limit

  monitoring:
    log_interval: 30          # Log pipeline status every N seconds

# ==============================================================================
# PATTERN DISCOVERY (External API)
# ==============================================================================
pattern_discovery:
  api_url: http://localhost:8001
  tier_filter: 1               # Only use Tier 1 validated patterns
  min_quality_score: 0.75      # Minimum pattern quality score

  # Coin selection from pattern's coin_performance
  coin_selection:
    min_edge: 0.10             # 10% minimum edge to include coin
    min_signals: 50            # Minimum signals for statistical reliability
    min_tradable_coins: 1      # Trust Pattern Discovery validation (Tier 1 = already anti-overfitting tested)
    # NOTE: max_coins is in backtesting.max_coins (shared with AI strategies)

  # Multi-target expansion: one pattern with N Tier 1 targets -> N strategies
  multi_target:
    enabled: true              # Enable multi-target expansion
    min_edge_for_expansion: 0.05  # 5% min edge per target to expand
    max_targets_per_pattern: 5    # Limit expansion per pattern

# ==============================================================================
# VALIDATION (Strategy Code Validation)
# ==============================================================================
validation:
  parallel_threads: 5

# ==============================================================================
# BACKTESTING
# ==============================================================================
backtesting:
  initial_capital: 10000
  parallel_threads: 10

  # Coins per backtest (applies to BOTH pattern and AI strategies)
  # Pattern: selects top N coins by edge from pattern's coin_performance
  # AI: selects top N coins by volume from active trading pairs
  max_coins: 30

  # Training/Holdout split (unified approach)
  # Total period = training_days + holdout_days = 210 days
  training_days: 365         # 12 months for training (robust statistical validation)
  holdout_days: 30           # Last 30 days for validation (anti-overfitting + recency)

  # Holdout validation thresholds
  holdout:
    max_degradation: 0.50    # Max 50% degradation from training to holdout
    min_sharpe: 0.0          # Holdout Sharpe must be positive
    recency_weight: 0.60     # Weight for holdout score in final ranking
    min_trades: 3            # Minimum trades required in holdout period

  # Minimum thresholds (gate check - classifier does the real ranking)
  thresholds:
    min_sharpe: 0.3          # Minimum Sharpe ratio
    min_win_rate: 0.35       # 35% minimum win rate
    min_total_trades: 10     # Minimum trades for significance
    min_expectancy: 0.0      # Must have positive expectancy
    max_drawdown: 0.50       # Max 50% drawdown (now correctly calculated)

  # NOTE: realistic_mode and max_concurrent_positions removed
  # Backtest uses risk.limits.max_open_positions_per_subaccount for position limits

# ==============================================================================
# TRADING (Live Execution Policy)
# ==============================================================================
trading:
  min_volume_24h: 1000000      # $1M min volume for live trading (liquidity filter)
  pairs_mode: strict           # strict, adaptive, intersection
  require_backtest: true       # Only trade pairs that were backtested

# ==============================================================================
# CLASSIFICATION & SELECTION
# ==============================================================================
classification:
  frequency_hours: 1

  # Backtest scoring weights (expectancy is dominant)
  score_weights:
    edge: 0.50        # Expectancy - most important metric
    sharpe: 0.25      # Risk-adjusted return
    consistency: 0.15 # Win rate / time-in-profit
    stability: 0.10   # Walk-forward stability

  # Filter thresholds for eligible strategies
  filter_thresholds:
    min_sharpe: 0.5           # Minimum Sharpe ratio
    min_win_rate: 0.40        # Minimum win rate (40%)
    min_trades: 20            # Minimum trades for statistical significance

  # Live ranking configuration
  live_ranking:
    enabled: true
    min_trades_live: 10          # Minimum trades before calculating live metrics
    min_trades_for_frequency: 10 # Minimum trades to calculate trade frequency for Sharpe annualization
    min_days_for_frequency: 7    # Minimum days active for reliable frequency calculation
    retire_score_threshold: 30   # Score < 30 = retire
    max_degradation_pct: 0.50    # 50% worse than backtest = retire
    max_drawdown_live: 0.30      # 30% live drawdown = retire

  # Selection configuration
  selection:
    top_n: 10                    # Max strategies to select
    max_per_type: 3              # Max strategies per type (MOM, REV, etc.)
    max_per_timeframe: 3         # Max strategies per timeframe

  # Diversification (deprecated, use selection above)
  diversification:
    max_same_type: 3
    max_same_timeframe: 5

# ==============================================================================
# DEPLOYMENT & ROTATION
# ==============================================================================
deployment:
  rotation_frequency_hours: 24
  shutdown:
    close_positions: false
    cancel_orders: true

# ==============================================================================
# SUBACCOUNT MANAGER
# ==============================================================================
subaccount_manager:
  dry_run: true
  rotation_interval_hours: 24
  rebalance_enabled: true

# ==============================================================================
# EXECUTOR (Live Trading Loop)
# ==============================================================================
executor:
  check_interval_seconds: 15       # How often to check for signals

# ==============================================================================
# MONITORING
# ==============================================================================
monitoring:
  snapshot_interval_minutes: 15
  check_interval_seconds: 30

# ==============================================================================
# LOGGING
# ==============================================================================
logging:
  level: INFO
  file: logs/sixbtc.log
  max_bytes: 10485760
  backup_count: 5
  modules:
    orchestrator: INFO
    executor: INFO
    backtester: INFO
    generator: INFO
    data_provider: WARNING

# ==============================================================================
# DATA SCHEDULER
# ==============================================================================
data_scheduler:
  enabled: true
  update_hours: [4, 16]
  top_pairs_count: 200
  min_volume_usd: 0
  download_days: null

