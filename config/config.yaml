# ==============================================================================
# SIXBTC MASTER CONFIGURATION
# ==============================================================================
# Last updated: 2025-12-20
# Version: 1.0.0
#
# IMPORTANT: All values in this file are REQUIRED - no fallback defaults!
# Missing or invalid config will cause system to crash at startup (Fast Fail)
# Sensitive credentials (API keys, passwords) go in .env, NOT here

system:
  name: "SixBTC"
  version: "1.0.0"
  execution_mode: hybrid  # sync, async, multiprocess, hybrid

# ==============================================================================
# GLOBAL TIMEFRAMES (used by downloader, generator, backtester, executor)
# ==============================================================================
timeframes: ['15m', '30m', '1h', '2h']

# ==============================================================================
# DIRECTORIES
# ==============================================================================
directories:
  data: data

# ==============================================================================
# DATABASE (PostgreSQL via Docker)
# ==============================================================================
database:
  # Connection settings (from .env)
  host: ${DB_HOST}
  port: ${DB_PORT}
  database: ${DB_NAME}
  user: ${DB_USER}
  password: ${DB_PASSWORD}

  pool:
    min_connections: 5
    max_connections: 50
    pool_recycle: 3600

# ==============================================================================
# HYPERLIQUID EXCHANGE
# ==============================================================================
hyperliquid:
  # Master address for all operations (from .env: HL_MASTER_ADDRESS)
  # Used for read-only queries, WebSocket, and as reference for subaccount operations
  user_address: "${HL_MASTER_ADDRESS}"

  # MASTER dry_run flag - controls ALL trading behavior
  # true = no real orders (safe testing)
  # false = real orders (live trading)
  dry_run: true

  # Testnet mode (if true, uses testnet API)
  testnet: false

  # --------------------------------------------------------------------------
  # SUBACCOUNTS
  # --------------------------------------------------------------------------
  # Subaccounts are managed via scripts/setup_hyperliquid.py
  # Master wallet credentials are in .env: HL_MASTER_ADDRESS, HL_MASTER_PRIVATE_KEY
  subaccounts:
    count: 3                       # Target number of subaccounts (max 10 per HL)
    naming_pattern: "Bot-{:03d}"   # Pattern for names: Bot-001, Bot-002, etc.

  # --------------------------------------------------------------------------
  # AGENT WALLETS
  # --------------------------------------------------------------------------
  # Agent wallets are API keys for trading (no withdrawal permissions)
  # Created automatically by scripts/setup_hyperliquid.py
  # Credentials stored in database (Credential table)
  agent_wallet:
    validity_days: 180             # Max validity (Hyperliquid limit)
    renewal_days_before_expiry: 30 # Renew 30 days before expiration

  # --------------------------------------------------------------------------
  # FUND MANAGEMENT
  # --------------------------------------------------------------------------
  # Automatic topup from master to subaccounts when balance falls below threshold
  # Policy: topup only from master, NEVER between subaccounts
  funds:
    min_operational_usd: 50        # Below this → trigger topup
    topup_target_usd: 100          # Target balance after topup
    master_reserve_usd: 100        # Never drain master below this
    min_tradeable_usd: 15          # Below this → subaccount cannot trade
    check_interval_hours: 24       # How often to check balances

  # --------------------------------------------------------------------------
  # FEES AND EXECUTION
  # --------------------------------------------------------------------------
  # Fees for backtesting (taker fee = market orders)
  fee_rate: 0.00045  # 0.045% taker fee
  slippage: 0.0005   # 0.05% estimated slippage
  min_notional: 10.0  # Minimum trade size in USDC (Hyperliquid requirement)

  websocket:
    ping_interval: 30
    ping_timeout: 10

  # Trade sync configuration
  # Synchronizes closed trades from Hyperliquid to database
  trade_sync:
    enabled: true
    fills_lookback_days: 7  # How far back to look for fills

# ==============================================================================
# RISK MANAGEMENT
# ==============================================================================
risk:
  # Fixed Fractional position sizing (only mode supported)
  fixed_fractional:
    risk_per_trade_pct: 0.02       # 2% risk per trade
    max_position_size_pct: 0.20   # Max 20% of equity per position

  limits:
    max_open_positions_per_subaccount: 10  # Increased from 6

  emergency:
    max_portfolio_drawdown: 0.30
    max_daily_loss: 0.10
    max_subaccount_drawdown: 0.25
    max_consecutive_losses: 5

  # Trailing stop configuration
  trailing:
    enabled: true                    # Enable trailing stop service
    min_adjustment_pct: 0.005        # Min 0.5% improvement to update SL
    update_cooldown_sec: 10          # Min seconds between SL updates
    breakeven_buffer_pct: 0.002      # 0.2% buffer above breakeven

# ==============================================================================
# AI CONFIGURATION
# ==============================================================================
ai:
  mode: cli  # "cli" or "api"
  cli:
    model: claude
    timeout: 300
  api:
    model: claude-sonnet-4-20250514
    timeout: 120
  # Daily AI call limit (prevents runaway costs)
  daily_limit:
    enabled: true
    max_calls: 500       # Max AI calls per day
    reset_hour: 0        # Reset at midnight (local time)

# ==============================================================================
# GENERATION (AI Templates + Parametric Variations)
# ==============================================================================
generation:
  min_interval_seconds: 0      # Min seconds between AI calls
  parallel_threads: 1
  # NOTE: Each template generates ALL parametric variations (no AI cost)
  # Flow control is handled by pipeline backpressure below
  # Leverage is read from DB (coins.max_leverage), not configured here

  # Parametric optimization (runs in Backtester, not Generator)
  # Parameter space defined in src/backtester/parametric_constants.py (per-timeframe)
  parametric:
    enabled: true              # Enable parametric optimization in Backtester

  # Strategy sources - enable/disable each type
  # Names match generation_mode values for consistency
  strategy_sources:
    pattern:
      enabled: true            # PatStrat_* from pattern-discovery API
    ai_free:
      enabled: true            # Strategy_* - AI chooses indicators freely
    ai_assigned:
      enabled: true            # Strategy_* - AI uses IndicatorCombinator-assigned indicators

  # When both AI sources are enabled, this ratio controls the mix
  # ai_free_ratio: 0.7 means 70% ai_free, 30% ai_assigned
  ai_free_ratio: 0.7

  # Indicator combinator settings (for ai_assigned strategies)
  indicator_combinator:
    max_main_indicators: 3     # 2 or 3 main indicators
    max_filter_indicators: 2   # 0, 1, or 2 filters
    prefer_2_indicators: true  # Try 2-indicator combos before 3-indicator

# ==============================================================================
# ACTIVE POOL (Leaderboard Logic)
# ==============================================================================
# Pool of strategies ready for deployment, managed via leaderboard
# New strategies enter if: score >= min_score AND (pool not full OR score > min(pool))
# NOTE: All strategies in ACTIVE are eligible for LIVE deployment (single threshold)
active_pool:
  max_size: 300                  # Max strategies in pool (leaderboard)
  min_score: 40                  # Minimum score to enter pool (and be LIVE eligible)

# ==============================================================================
# PIPELINE FLOW CONTROL (Multi-Level Backpressure System)
# ==============================================================================
# Prevents queue overflow by limiting strategies at each stage.
# Each module checks its downstream queue before processing.
# System self-regulates: slow backtester -> queues fill -> upstream pauses
pipeline:
  queue_limits:
    generated: 500      # Max GENERATED strategies (supports one parametric batch ~400)
    validated: 500      # Max VALIDATED strategies waiting for backtest
    # ACTIVE pool uses active_pool.max_size (leaderboard logic)

  backpressure:
    check_interval: 10        # Seconds between backpressure checks
    base_cooldown: 30         # Base cooldown when backpressure triggers
    max_cooldown: 120         # Maximum cooldown (2 minutes)
    cooldown_increment: 2     # Extra seconds per strategy over limit

  monitoring:
    log_interval: 30          # Log pipeline status every N seconds

# ==============================================================================
# PATTERN DISCOVERY (External API)
# ==============================================================================
pattern_discovery:
  api_url: http://localhost:8001
  tier_filter: 1               # Only use Tier 1 validated patterns
  min_quality_score: 0.75      # Minimum pattern quality score

  # Coin selection from pattern's coin_performance
  # Uses ALL coins meeting edge/signals criteria + liquidity filter from trading.min_volume_24h
  coin_selection:
    min_edge: 0.10             # 10% minimum edge to include coin
    min_signals: 50            # Minimum signals for statistical reliability

  # Multi-target expansion: one pattern with N Tier 1 targets -> N strategies
  multi_target:
    enabled: true              # Enable multi-target expansion
    min_edge_for_expansion: 0.05  # 5% min edge per target to expand
    max_targets_per_pattern: 5    # Limit expansion per pattern

# ==============================================================================
# VALIDATION (Strategy Code Validation)
# ==============================================================================
validation:
  parallel_threads: 6

# ==============================================================================
# BACKTESTING
# ==============================================================================
backtesting:
  initial_capital: 10000
  batch_size: 500        # Strategies per batch for same base_code_hash

  # Thread allocation (3+1 elastic model for LIVE mode)
  threads:
    validated: 3             # Dedicated threads for new VALIDATED strategies
    retest: 1                # Elastic thread: re-backtest first, then VALIDATED if empty

  # Re-backtest configuration for ACTIVE pool freshness
  retest:
    interval_days: 3         # Re-test ACTIVE strategies every 3 days
    # Re-backtest uses: optimal TF only, 365+30 days, same parameters (no parametric)

  # Max coins for AI strategies (pattern strategies use ALL coins meeting edge criteria)
  max_coins: 30              # Top 30 by volume for AI strategies

  # In-sample/Out-of-sample split (unified approach)
  # Total period = is_days + oos_days = 150 days
  is_days: 120               # 4 months in-sample (rotation-based system, recent regimes)
  oos_days: 30               # Last 30 days out-of-sample (anti-overfitting + recency)
  min_coverage_pct: 0.80     # 80% minimum data coverage required for coins

  # Minimum trades per timeframe (parallel arrays with timeframes config)
  # timeframes: ['15m', '30m', '1h', '2h']
  min_trades:
    in_sample:    [240, 180, 120, 60]  # For 120d IS period: 15m, 30m, 1h, 2h
    out_of_sample: [60,  45,  30, 15]  # For 30d OOS period

  # Out-of-sample validation thresholds
  out_of_sample:
    max_degradation: 0.50    # Max 50% degradation from IS to OOS
    min_sharpe: 0.0          # OOS Sharpe must be positive
    recency_weight: 0.60     # Weight for OOS score in final ranking

  # Walk-Forward Validation with FIXED parameters
  # Runs AFTER shuffle test, BEFORE pool entry
  # Tests if the best combo (params already embedded) performs consistently
  # across 4 expanding time windows. Uses expectancy >= min_expectancy (0.002)
  # as profitability criterion (more direct than Sharpe).
  wfa_validation:
    enabled: true
    window_percentages: [0.25, 0.50, 0.75, 1.0]  # Expanding windows
    min_profitable_windows: 4                     # All 4 windows must be profitable

  # Minimum thresholds (gate check - classifier does the real ranking)
  thresholds:
    min_sharpe: 0.3          # Minimum Sharpe ratio
    min_win_rate: 0.35       # 35% minimum win rate
    min_total_trades: 10     # Minimum trades for significance
    min_expectancy: 0.002    # 0.2% per trade minimum (covers fees + ensures profitability)
    max_drawdown: 0.50       # Max 50% drawdown (now correctly calculated)

  # NOTE: realistic_mode and max_concurrent_positions removed
  # Backtest uses risk.limits.max_open_positions_per_subaccount for position limits

# ==============================================================================
# TRADING (Live Execution Policy)
# ==============================================================================
trading:
  # NOTE: n_subaccounts REMOVED - use hyperliquid.subaccounts.total instead
  total_capital: 300           # Total capital across all subaccounts ($) - 3 x $100
  min_volume_24h: 1000000      # $1M min volume for live trading (liquidity filter)
  pairs_mode: strict           # strict, adaptive, intersection
  require_backtest: true       # Only trade pairs that were backtested

# ==============================================================================
# SCORER (Score Calculation)
# ==============================================================================
scorer:
  # Unified scoring weights (used for both backtest and live)
  # Score = weighted sum of 5 normalized components (0-100 each)
  # All weights must sum to 1.0
  weights:
    expectancy: 0.40  # Expectancy - most important metric (+5% from removed robustness)
    sharpe: 0.25      # Risk-adjusted return (+5% from removed robustness)
    win_rate: 0.10    # Win rate (trades won / total trades)
    drawdown: 0.15    # Penalizes high drawdown (lower DD = higher score)
    recency: 0.10     # Recent performance vs training (from holdout degradation)

# ==============================================================================
# ROTATOR (ACTIVE -> LIVE Deployment)
# ==============================================================================
rotator:
  check_interval_minutes: 15     # Check every 15 min for deployment opportunities
  max_live_strategies: 10        # Max strategies in LIVE at once
  min_pool_size: 100             # Don't deploy until ACTIVE pool has >= 100 strategies
  # NOTE: min_score for LIVE eligibility uses active_pool.min_score (single threshold)

  # Diversification rules
  selection:
    max_per_type: 3              # Max strategies per type (MOM, REV, etc.)
    max_per_timeframe: 3         # Max strategies per timeframe

# ==============================================================================
# MONITOR (LIVE Performance & Retirement)
# ==============================================================================
monitor:
  check_interval_minutes: 15     # Check every 15 min for retirement candidates

  # Retirement criteria (any triggers retirement)
  retirement:
    min_score: 35                # Score < 35 = retire (closer to entry threshold)
    max_degradation: 0.40        # 40% worse than backtest = retire
    max_drawdown: 0.25           # 25% live drawdown = retire ($25 max loss on $100)
    min_trades: 10               # Min trades before evaluating

  # Live scoring (for calculating score_live)
  live_scoring:
    min_trades_for_frequency: 10 # Min trades to calculate trade frequency
    min_days_for_frequency: 7    # Min days active for reliable frequency

# ==============================================================================
# CLASSIFICATION (LEGACY - Uses scorer.weights now)
# ==============================================================================
classification:
  frequency_hours: 0.25  # Every 15 minutes

  # DEPRECATED: Use scorer.weights instead (unified formula)
  # Kept for backwards compatibility during transition
  score_weights:
    expectancy: 0.45
    sharpe: 0.25
    win_rate: 0.15
    drawdown: 0.15

  filter_thresholds:
    min_sharpe: 0.5
    min_win_rate: 0.40
    min_trades: 20

  live_ranking:
    enabled: true
    min_trades_live: 10
    min_trades_for_frequency: 10
    min_days_for_frequency: 7
    retire_score_threshold: 30
    max_degradation_pct: 0.50
    max_drawdown_live: 0.30

  selection:
    top_n: 10
    max_per_type: 3
    max_per_timeframe: 3

  diversification:
    max_same_type: 3
    max_same_timeframe: 5

  archival:
    enabled: true
    score_threshold: 15
    max_per_cycle: 50
    min_age_hours: 1

# ==============================================================================
# DEPLOYMENT (LEGACY - Will be replaced by ROTATOR)
# ==============================================================================
deployment:
  rotation_frequency_hours: 24
  shutdown:
    close_positions: false
    cancel_orders: true

# ==============================================================================
# SUBACCOUNT MANAGER
# ==============================================================================
subaccount_manager:
  # dry_run removed - uses hyperliquid.dry_run as single source of truth
  rotation_interval_hours: 24
  rebalance_enabled: true

# ==============================================================================
# EXECUTOR (Live Trading Loop)
# ==============================================================================
executor:
  check_interval_seconds: 15       # How often to check for signals

# ==============================================================================
# MONITORING
# ==============================================================================
monitoring:
  snapshot_interval_minutes: 15
  check_interval_seconds: 15

# ==============================================================================
# METRICS & ANALYTICS
# ==============================================================================
metrics:
  # Collection interval for pipeline snapshots
  collection_interval: 60         # 1 minute (60 seconds)

  # Data retention policies
  retention:
    raw_days: 7                   # Keep 5-min snapshots for 7 days
    hourly_days: 30               # Keep hourly aggregates for 30 days
    daily_forever: true           # Keep daily aggregates forever

  # Alert thresholds
  alerts:
    enabled: true

    backpressure:
      threshold: 0.90             # 90% queue utilization
      duration_minutes: 60        # Sustained for 1 hour

    throughput_degradation:
      min_strategies_per_hour: 5
      duration_hours: 2

    quality_degradation:
      min_sharpe: 0.3
      duration_hours: 24

# ==============================================================================
# LOGGING
# ==============================================================================
logging:
  level: INFO
  file: logs/sixbtc.log
  max_bytes: 10485760
  backup_count: 5
  modules:
    orchestrator: INFO
    executor: INFO
    backtester: INFO
    generator: INFO
    data_provider: WARNING

# ==============================================================================
# SCHEDULER (Maintenance Tasks)
# ==============================================================================
scheduler:
  tasks:
    cleanup_zombie_processes:
      enabled: true
      interval_hours: 3           # Every 3 hours
    daily_restart_services:
      enabled: true
      interval_hours: 24          # Once per day
      restart_hour: 2             # Run at 2 AM (low activity)

    # Agent wallet credential renewal (checks daily, renews if expiring within 30 days)
    renew_agent_wallets:
      enabled: true
      interval_hours: 24          # Check once per day
      run_hour: 3                 # Run at 3 AM

    # Subaccount fund management (topup from master if balance low)
    check_subaccount_funds:
      enabled: true
      interval_hours: 24          # Check once per day
      run_hour: 4                 # Run at 4 AM (after agent renewal)

    # Clean /tmp directory (remove old temporary files)
    cleanup_tmp_dir:
      enabled: true
      interval_hours: 24          # Once per day
      run_hour: 5                 # Run at 5 AM
      max_age_hours: 24           # Delete files older than 24 hours

# ==============================================================================
# DATA SCHEDULER
# ==============================================================================
data_scheduler:
  enabled: true
  update_hours: [4, 16]
  top_pairs_count: 200
  min_volume_usd: 0
  download_days: null

